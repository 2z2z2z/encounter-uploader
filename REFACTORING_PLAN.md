# Рефакторинг и оптимизации Encounter Uploader

## Обзор проекта

Encounter Uploader - веб-приложение для загрузки уровней игры Encounter с поддержкой различных типов. Тип уровня - это заранее настроенный пресет полей, заполнив контент которых, пользователь может отправить этот контент в Encounter. Текущие типы уровней:
1. Олимпийки (15, 31, 63, 127 секторов как подтипы)
2. 100500 секторов и бонусов

В будущем планируется 20+ типов уровней для загрузки. У каждого типа будут свой набор полей из общего списка полей, а также своя конфигурация "заливки" этих полей.
Страница заливки является по сути инструментом для наполнения контентом этих полей в рамках выбранного типа уровня для дальнейшей правильной "заливки" (отправки) этого контента в Encounter.

## Ключевые цели рефакторинга
- исключение дублируюшего кода, функций, интерфейса
- максимизация переиспользования (компоненты, поля, элементы интерфейса)
- стандартизация (хранение данных, использование данных, отправка данных)
- упрощение и корректная настройка серверной части
- готовность к легкому добавлению новых типов уровней
- готовность к масштабированию и новому функционалу, который будет подключаться модульно, а не "наростом"

### Предлагается добиться следующими решениями
1. Единый список полей, в которых загружаются данные при "заливке (заданий, секторов, бонусов)". Удобная и практичная регистрация новых полей в общем списке.
2. Единый список контрол-элементов (для массового редактирования таблицы контента).
2. Связывание полей с контрол-элементами из контрол-панели для массового редактирования. К примеру, для поля "Название секторов" (в таблице контента) привязывается контрол-элемент "Название секторов" (в контрол-панели), который будет использоваться только для этого поля. Для привязки нужно проанализировать текущие связи.
3. Унификация всех типов уровней - создание общей архитектуры для Олимпиек, Type100500 и будущих типов. Настройка типов уровней через конфиги. Легкое добавление новых типов уровней, конструктор отправляемых данных через указание нужных полей из общего списка полей
4. Общий шаблон страницы загрузки (за эталонный взять "100500 секторов и бонусов"), состоящий из:
 а) информация о типе уровня (название, данные из настроек на предыдущем шаге, один набор данных)
 б) таблица для заполнения контента для отправки (с настраиваемым списком полей из единого списка)
 в) контрол-панель для массового редактирования полей таблицы контента (привязанные к поля контрол-элементы из единого списка)
 г) нижний бар с кнопками (назад, очистка, экспорт, импорт, предпросмотр, заливка задания, заливка секторов, заливка бонусов, чекбокс "Объединить сектора (БМП)").
 
Постоянные кнопки для всех типов уровней:
Кнопки назад, очистка, экспорт и импорт во всех типах выполняют одинаковые действия и присутствуют всегда.
 
Наличие кнопки зависит от настройки типа уровня и его полей:
 - Кнопка "Предпросмотр" по сути отображает то, что будет отправлено по кнопке "Залить задание", то есть если есть "Залить задание", то и должна быть кнопка "Предпросмотр".
 - Кнопка "Залить задание" в зависимости от типа уровня может иметь разное содержание. Не для всех типов уровней эта кнопка будет нужна.
 - Кнопка "Залить сектора" (с или без чекбокса "Объединить сектора (БМП)" всегда заливают одинаковый набор полей - ответы и их варианты).
 - Кнопка "Залить бонусы" заливает разный набор полей для каждого типа уровня.
5. Четкая стандартизация отправляемых данных, сборщик Payload, для каждого типа уровня свой набор отправляемых полей. Легкое добавление полей в Payload из единого списка полей
6. Исключение backend в пользу server, улучшение настройки при необходимости

### Тестирование и проверка проекта
Необходимо не допустить изменение интерфейса UI (потеря стилей, перестановка блоков, ошибка в верстке и т.д.). Для проверки что "ничего не поехало и все работает не хуже, чем до выполнения рефакторинга" предлагается тестировать интерфейс. Чтобы не задействовать функции проверки авторизации и ID игры, добавлены тестовый логин и пароль: test/test.
Для каждого шага рефакторинга, который так или иначе может касаться интерфейса предлагается смотреть как выглядят основные страницы (авторизация, настройка, "Олимпийка 127" и "100500 секторов и бонусов") с использованием playwright после шага рефакторинга, справнивая как выглядели до.

### Документации к модулям, плагинам и прочему
При работе с каким-либо модулем, плагином и т.п. (например, при установке или при использовании новых функций, которые еще не были задействованы) необходимо обращаться к документации этого моделя или плагина с помощью context7!

## План рефакторинга

Шаг 0. Базовые скриншоты UI (визуальные эталоны)
0.1 Установить Playwright (`@playwright/test`), инициализировать конфиг с viewport 1920×1080.
0.2 Подготовить тестовые сценарии: переходы на `/login`, `/settings`, `/upload` (для типов `olymp127` и `100500`).
0.3 В сценариях использовать тест-режим логина `test/test` для обхода проверок домена/ID.
0.4 Снять baseline-скриншоты всех целевых страниц и ключевых модалок (в т.ч. «Предпросмотр» для олимпийки).
0.5 Проверка: повторные прогоны совпадают с baseline без диффов.

Шаг 1. Консолидация серверной части
1.1 Удалить директорию `backend/` и сервис `backend` из `docker-compose.yml`.
1.2 Упростить `frontend/nginx.conf`: маршрут `location /api/ { proxy_pass http://server:3001; ... }` как единая точка.
1.3 Убедиться, что Vite dev-proxy (`vite.config.ts`) направляет `/api` на `http://localhost:3001`.
1.4 Проверить прохождение cookie/Set-Cookie через Nginx и `express-session` (login → admin-запрос → refresh cookie).
1.5 Проверка: `docker-compose up --build`; фронтенд на `http://127.0.0.1:8099`; авторизация и заливка работают.

Шаг 2. Очистка фронтенда от легаси
2.1 Удалить `frontend/src/services/api.ts` (маршруты `/api/login`, `/api/upload`).
2.2 Удалить устаревший `useAuthStore` из `frontend/src/store/index.ts`.
2.3 Пройтись по импортам/использованиям и убедиться, что везде используется `frontend/src/store/auth.ts`.
2.4 Сборка и быстрый прогон UI.
2.5 Проверка: авторизация и навигация работают; визуальные тесты без диффов.

Шаг 3. Нормализация типов уровней
3.1 Переименовать тип `olymp` → `olymp15` во всех местах (store/router/компоненты).
3.2 Зафиксировать набор типов: `olymp15`, `olymp31`, `olymp63`, `olymp127`, `100500`.
3.3 (Опционально на один релиз) В рантайме маппить устаревшее значение `uploadType=olymp` на `olymp15` для совместимости с локальным storage.
3.4 Проверка: выбор типа на `/settings` корректно отображает соответствующую страницу.

Шаг 4. Единый реестр полей (global fields registry)
4.1 Создать `frontend/src/components/level-system/registry/schema.ts` (интерфейсы полей/строк/уровневых конфигов).
4.2 Создать `registry/fields.ts` со списком полей (не привязанных к типам).
4.3 Типы уровней лишь подключают нужные поля в своих конфигах (см. Шаг 6).
4.4 Стартовый состав полей:
  - Ответы: `variants: string[]` (до 10).
  - Флаги: `inSector: boolean`, `inBonus: boolean`.
  - Бонусное время: `{ hours, minutes, seconds, negative }`.
  - Олимпийка (контент ячеек): `closedText`, `displayText`.
  - 100500 (имена): `sectorName`, `bonusName`.
  - 100500 (контент): `bonusTask?`, `bonusHint?`.
  - 100500 (время): `delay? { h,m,s }`, `relativeLimit? { h,m,s }`.
  - 100500 (уровни): `targetLevels?: string[]`, `allLevels?: boolean`.
  - HTML «задание» (скрытое поле): `htmlTask` — используется при отправке «Залить задание». По умолчанию — шаблон таблицы для олимпийки; для будущих типов может иметь иное содержимое.
4.5 Проверка: проект собирается; визуальные тесты без диффов.

Шаг 5. Единый реестр контролов (mass-edit controls)
5.1 Создать `registry/controls.ts` с описаниями контролов и их назначением.
5.2 Задать привязки контролов к полям (массовое применение, формулы подстановки паттернов `&` и т.п.).
5.3 Для 100500 описать модал «Уровни бонусов» и API получения списка уровней (уже реализовано — связать с реестром).
5.4 Опция «Объединить сектора (БМП)» — флаг конфигурации типа; влияет на «Залить сектора».
5.5 Проверка: функционал контролов сохраняется; визуальные тесты без диффов.
  - Общие: «Быстрое бонусное время» (+ чекбокс «–» → `negative`).
  - Олимпийка: `sectorMode` (all/initialAndFinal/finalOnly/custom), `closedPattern`, «Заполнить открытые».
  - 100500: `sectorPattern`, `bonusPattern`, `bonusTaskPattern`, `bonusHintPattern`, «Задержка», «Ограничение», «Уровни бонусов» (модалка).
  - Опция «Объединить сектора (БМП)» — управляет поведением кнопки «Залить сектора» и включается по конфигу типа.
- Проверка: функционал контролов сохраняется, визуальные тесты без диффов.

Шаг 6. Конфиги типов уровней
6.1 Создать `registry/types/olymp.ts` и `registry/types/type100500.ts`.
6.2 Для каждого типа указать: поля из реестра, контролы, кнопки (`enableTask`, `enablePreview`, `enableSectors`, `enableBonuses`, `combineSectorsAvailable`).
6.3 Олимпийки: `enableTask/enablePreview=true`; `100500`: оба `false`.
6.4 Проверка: набор кнопок и поведение соответствуют конфигу; визуальные тесты без диффов.

Шаг 7. Единый компонент олимпийки
7.1 Создать `OlympBase.vue` (проп `totalSectors`).
7.2 Переподключить `olymp15/31/63/127` как тонкие обёртки к базе.
7.3 Вынести экспорт/импорт, предпросмотр, отправки в композиции/сервисы (минимум дублирования).
7.4 Для «Задания» использовать скрытое поле `htmlTask` (генерация закрытой таблицы по `totalSectors`).
7.5 Проверка: визуальные тесты для `olymp127` совпадают с baseline; отправки «задание/сектора/бонусы» работают.

Шаг 8. Type100500
8.1 Оставить отдельным типом, перевести на реестр полей/контролов.
8.2 Привязать чекбокс «Объединить сектора (БМП)» к поведению «Залить сектора» (соответствующая ветка логики уже есть).
8.3 Проверка: визуальные тесты для `100500` без диффов; массивные отправки проходят стабильно.

Шаг 9. Стандартизация отправок и устойчивость
9.1 Параметризовать задержку `VITE_SLEEP_MS` (дефолт 1200) и использовать в `uploader.ts`.
9.2 Подключить `axios-retry` (или эквивалент) с экспоненциальным backoff и джиттером.
9.3 Настроить правила ретраев: безопасно ретраить GET, для POST — только при 429/сетевых сбоях, с ограничением попыток.
9.4 Сохранить семантику бонусов: `rbAllLevels=0/1`, отметка чекбоксов уровней.
9.5 Проверка: прогон массовых заливок на «медленной сети» без сбоев; UI неизменен.

Шаг 10. Обновление зависимостей
10.1 Обновить пакеты фронтенда/сервера до последних минор/патч-версий.
10.2 Пересобрать Docker-образы и проверить запуск.
10.3 Проверка: сборка зелёная; визуальные тесты без диффов.

Шаг 11. Документация
11.1 Создать `README.md` с техническим описанием проекта (как он устроен), примерами добавления полей/контролов/новых типов, краткой памяткой по «как добавить новый тип уровня» (через конфиг и, при необходимости, новый компонент).
11.2 Проверка: все шаги повторяемы по инструкции.

### Необходимые библиотеки, модули или плагины
- Playwright (`@playwright/test`) — визуальные регрессионные тесты (скриншоты 1920×1080; страницы `/login`, `/settings`, `/upload` для `olymp127` и `100500`).
- axios-retry — ретраи и backoff для запросов к EN (429/5xx).
- TypeScript (уже есть) — типизированный реестр полей/контролов и конфиги типов.
- Vite `.env` — параметризация `VITE_SLEEP_MS` (без дополнительных пакетов).

Примечание: единый реестр полей хранит сами поля (включая `htmlTask`) независимо от типов уровней; конкретные типы подключают нужные поля/контролы через свои конфиги.