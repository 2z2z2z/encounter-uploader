# Рефакторинг и оптимизации Encounter Uploader

## Обзор проекта

Encounter Uploader - веб-приложение для загрузки уровней игры Encounter с поддержкой различных типов. Тип уровня - это заранее настроенный пресет полей, заполнив контент которых, пользователь может отправить этот контент в Encounter. Текущие типы уровней:
1. Олимпийки (15, 31, 63, 127 секторов как подтипы)
2. 100500 секторов и бонусов

В будущем планируется 20+ типов уровней для загрузки. У каждого типа будут свой набор полей из общего списка полей, а также своя конфигурация "заливки" этих полей.
Страница заливки является по сути инструментом для наполнения контентом этих полей в рамках выбранного типа уровня для дальнейшей правильной "заливки" (отправки) этого контента в Encounter.

## Ключевые цели рефакторинга
- исключение дублируюшего кода, функций, интерфейса
- максимизация переиспользования (компоненты, поля, элементы интерфейса)
- стандартизация (хранение данных, использование данных, отправка данных)
- упрощение и корректная настройка серверной части
- готовность к легкому добавлению новых типов уровней
- готовность к масштабированию и новому функционалу, который будет подключаться модульно, а не "наростом"

### Предлагается добиться следующими решениями
1. Единый список полей, в которых загружаются данные при "заливке (заданий, секторов, бонусов)". Удобная и практичная регистрация новых полей в общем списке.
2. Единый список контрол-элементов (для массового редактирования таблицы контента).
2. Связывание полей с контрол-элементами из контрол-панели для массового редактирования. К примеру, для поля "Название секторов" (в таблице контента) привязывается контрол-элемент "Название секторов" (в контрол-панели), который будет использоваться только для этого поля. Для привязки нужно проанализировать текущие связи.
3. Унификация всех типов уровней - создание общей архитектуры для Олимпиек, Type100500 и будущих типов. Настройка типов уровней через конфиги. Легкое добавление новых типов уровней, конструктор отправляемых данных через указание нужных полей из общего списка полей
4. Общий шаблон страницы загрузки (за эталонный взять "100500 секторов и бонусов"), состоящий из:
 а) информация о типе уровня (название, данные из настроек на предыдущем шаге, один набор данных)
 б) таблица для заполнения контента для отправки (с настраиваемым списком полей из единого списка)
 в) контрол-панель для массового редактирования полей таблицы контента (привязанные к поля контрол-элементы из единого списка)
 г) нижний бар с кнопками (назад, очистка, экспорт, импорт, предпросмотр, заливка задания, заливка секторов, заливка бонусов, чекбокс "Объединить сектора (БМП)").
 
Постоянные кнопки для всех типов уровней:
Кнопки назад, очистка, экспорт и импорт во всех типах выполняют одинаковые действия и присутствуют всегда.
 
Наличие кнопки зависит от настройки типа уровня и его полей:
 - Кнопка "Предпросмотр" по сути отображает то, что будет отправлено по кнопке "Залить задание", то есть если есть "Залить задание", то и должна быть кнопка "Предпросмотр".
 - Кнопка "Залить задание" в зависимости от типа уровня может иметь разное содержание. Не для всех типов уровней эта кнопка будет нужна.
 - Кнопка "Залить сектора" (с или без чекбокса "Объединить сектора (БМП)" всегда заливают одинаковый набор полей - ответы и их варианты).
 - Кнопка "Залить бонусы" заливает разный набор полей для каждого типа уровня.
5. Четкая стандартизация отправляемых данных, сборщик Payload, для каждого типа уровня свой набор отправляемых полей. Легкое добавление полей в Payload из единого списка полей
6. Исключение backend в пользу server, улучшение настройки при необходимости

### Тестирование и проверка проекта
Необходимо не допустить изменение интерфейса UI (потеря стилей, перестановка блоков, ошибка в верстке и т.д.). Для проверки что "ничего не поехало и все работает не хуже, чем до выполнения рефакторинга" предлагается тестировать интерфейс. Чтобы не задействовать функции проверки авторизации и ID игры, добавлены тестовый логин и пароль: test/test.
Для каждого шага рефакторинга, который так или иначе может касаться интерфейса предлагается смотреть как выглядят основные страницы (авторизация, настройка, "Олимпийка 127" и "100500 секторов и бонусов") с использованием playwright после шага рефакторинга, справнивая как выглядели до.

### Документации к модулям, плагинам и прочему
При работе с каким-либо модулем, плагином и т.п. (например, при установке или при использовании новых функций, которые еще не были задействованы) необходимо обращаться к документации этого моделя или плагина с помощью context7!

## План рефакторинга

Шаг 0. Базовые скриншоты UI (визуальные эталоны)
- Установить e2e-визуальные тесты (Playwright). Снять baseline для страниц: `/login`, `/settings`, `/upload` c типами `olymp127` и `100500` при 1920×1080. Использовать тест-логин: `test/test`.
- Проверка: прогоны должны совпадать с baseline без диффов.

Шаг 1. Консолидация серверной части
- Удалить легаси `backend` и маршруты `/api/login`, `/api/upload` из кода/настроек.
- Упростить Nginx: все запросы `/api/*` проксировать на `server:3001` (единый upstream), сохранив текущую функциональность авторизации и админ-вызовов.
- Проверка: локальный запуск через Docker Compose; фронтенд доступен на `http://127.0.0.1:8099`, авторизация и заливка работают.

Шаг 2. Очистка фронтенда от легаси
- Удалить `frontend/src/services/api.ts` и устаревший `useAuthStore` внутри `frontend/src/store/index.ts`.
- Везде использовать `frontend/src/store/auth.ts` с тест-режимом `test/test`.
- Проверка: сборка фронтенда без ошибок, авторизация и навигация работают.

Шаг 3. Нормализация типов уровней
- Переименовать `olymp` → `olymp15` в сторах/роутах/компонентах.
- Зафиксировать текущие типы: `olymp15`, `olymp31`, `olymp63`, `olymp127`, `100500`. В будущем к олимпийкам можно добавлять новые (например, `olymp255`).
- Проверка: выбор типа на `/settings` корректно отображает нужную страницу заливки.

Шаг 4. Единый реестр полей (global fields registry)
- Создать единый список полей (не привязанный к типам). Типы уровней лишь выбирают нужные поля в своих конфигах.
- Стартовый состав полей:
  - Ответы: `variants: string[]` (до 10).
  - Флаги: `inSector: boolean`, `inBonus: boolean`.
  - Бонусное время: `{ hours, minutes, seconds, negative }`.
  - Олимпийка (контент ячеек): `closedText`, `displayText`.
  - 100500 (имена): `sectorName`, `bonusName`.
  - 100500 (контент): `bonusTask?`, `bonusHint?`.
  - 100500 (время): `delay? { h,m,s }`, `relativeLimit? { h,m,s }`.
  - 100500 (уровни): `targetLevels?: string[]`, `allLevels?: boolean`.
  - HTML «задание» (скрытое поле): `htmlTask` — используется при отправке «Залить задание». По умолчанию — шаблон таблицы для олимпийки; для будущих типов может иметь иное содержимое.
- Проверка: проект собирается; UI не меняется (визуальные тесты).

Шаг 5. Единый реестр контролов (mass-edit controls)
- Описать контролы и их привязки к полям:
  - Общие: «Быстрое бонусное время» (+ чекбокс «–» → `negative`).
  - Олимпийка: `sectorMode` (all/initialAndFinal/finalOnly/custom), `closedPattern`, «Заполнить открытые».
  - 100500: `sectorPattern`, `bonusPattern`, `bonusTaskPattern`, `bonusHintPattern`, «Задержка», «Ограничение», «Уровни бонусов» (модалка).
  - Опция «Объединить сектора (БМП)» — управляет поведением кнопки «Залить сектора» и включается по конфигу типа.
- Проверка: функционал контролов сохраняется, визуальные тесты без диффов.

Шаг 6. Конфиги типов уровней
- Для каждого типа описать: список полей из реестра, набор контролов, кнопки (enableTask/enablePreview/enableSectors/enableBonuses, combineSectorsAvailable).
- Олимпийки: включены «Предпросмотр» и «Залить задание»; 100500: выключены.
- Проверка: кнопки на нижнем баре соответствуют конфигу типа, UI стабилен.

Шаг 7. Единый компонент олимпийки
- Создать базовый компонент `OlympBase` с пропом `totalSectors` и переиспользовать его для `olymp15/31/63/127` (в перспективе — новых размеров).
- Вынести общую логику (экспорт/импорт, предпросмотр, отправки) в композиции.
- Проверка: визуальные тесты для `olymp127` совпадают с baseline; функции «задание/сектора/бонусы» работают.

Шаг 8. Type100500
- Оставить отдельным типом; подключить поля/контролы из реестра; привязать чекбокс «Объединить сектора (БМП)» к кнопке «Залить секторы».
- Проверка: визуальные тесты для `100500` совпадают с baseline; заливка секторов/бонусов работает.

Шаг 9. Стандартизация отправок и устойчивость
- Параметризовать задержку между запросами: `VITE_SLEEP_MS` (дефолт 1200).
- Добавить ретраи и экспоненциальный backoff на 429/5xx для запросов к EN.
- Сохранить текущую семантику уровней бонуса: `rbAllLevels=0` («все»), `1` («указанные») + отметка чекбоксов уровней.
- Проверка: массовые заливки отрабатывают стабильно (без блокировок/таймаутов), UI не меняется.

Шаг 10. Обновление зависимостей
- Обновить фронтенд/сервер до актуальных минор/патч-версий (Vue, Vite, Tailwind, Pinia, axios).
- Проверка: успешная сборка и прогоны визуальных тестов.

Шаг 11. Документация
- Обновить разделы о конфигурировании типов, добавлении новых полей и кнопок, а также инструкции запуска и тестирования.
- Проверка: документация соответствует фактическому коду.

### Необходимые библиотеки, модули или плагины
- Playwright (`@playwright/test`) — визуальные регрессионные тесты (скриншоты 1920×1080; страницы `/login`, `/settings`, `/upload` для `olymp127` и `100500`).
- axios-retry — ретраи и backoff для запросов к EN (429/5xx).
- TypeScript (уже есть) — типизированный реестр полей/контролов и конфиги типов.
- Vite `.env` — параметризация `VITE_SLEEP_MS` (без дополнительных пакетов).

Примечание: единый реестр полей хранит сами поля (включая `htmlTask`) независимо от типов уровней; конкретные типы подключают нужные поля/контролы через свои конфиги.