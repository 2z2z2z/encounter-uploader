## Encounter Uploader — техническое описание

Документ для разработчиков: из чего состоит проект, как устроена авторизация и проксирование, как работает заливка (задания, сектора, бонусы), где что лежит во фронтенде и на сервере, как расширять функциональность.

### Назначение

Веб‑инструмент для подготовки и «заливки» контента игр Encounter на конкретный домен EN: логин под аккаунтом автора, сборка HTML «задания», загрузка «секторов» и «бонусов» с нужными параметрами и задержками, контроль процесса и предпросмотр.

### Основные возможности

- Авторизация на любом домене EN (`{domain}.en.cx`) через прокси‑сервер; безопасное хранение сессионных cookie на сервере.
- Сохранение настроек между перезагрузками (Pinia + localStorage; выборочно — домен, игра, уровень, тип).
- Поддержка нескольких пресетов типов уровней: «Олимпийка» на 15/31/63/127 и заготовка «100500».
- Гибкая настройка: ID игры, № уровня, режим закрытия, варианты ответов, параметры бонусов.
- Пакетная загрузка сущностей:
  - Задание уровня (HTML табличная раскладка «олимпийки»);
  - Секторы (варианты ответов и закрытые названия);
  - Бонусы (название, варианты, время, «подсказка» для моментального отображения в таблице).
- Визуальный прогресс выполнения, предупреждения о переключении вкладок, системные уведомления по завершении.
- Для типа «100500»: выбор доступности бонуса по уровням — «на всех уровнях» или «на указанных уровнях» (персонально для каждой строки, есть массовое применение на весь блок). Список уровней парсится один раз с формы EN и может быть обновлён вручную.

## Архитектура и деплой

- **frontend**: Vue 3 + Vite + Pinia + Tailwind. Собирается в статику, отдаётся через Nginx, который также выступает как reverse‑proxy для API.
- **server**: Node.js (Express) «прокси‑сервер» для авторизации на EN и вызова админских страниц. Хранит куки авторизации в `express-session` и подставляет их в дальнейшие запросы к EN.
- **backend**: Node.js (Express, TypeScript) — вспомогательный/легаси API (`/api/login`, `/api/upload`). В текущей версии UI фактически не используется для авторизации и заливки, но остаётся в репозитории.
- **docker-compose**: поднимает три сервиса и публикует фронтенд на `127.0.0.1:8099`.

Стартовые точки:

- Nginx: `frontend/nginx.conf` — SPA‑роутинг и прокси `/api/*`.
- Прокси‑сервер: `server/index.js` — авторизация `/api/auth/login`, заливка `/api/admin/*`.
- Легаси backend: `backend/src/index.ts` — `/api/login`, `/api/upload` (через Nginx попадают на backend:3000).

Схема проксирования (из `frontend/nginx.conf`):

- `/api/auth/*` и `/api/admin/*` → `server:3001` (прокси‑сервер, работает с сессиями и куками EN).
- Любые прочие `/api/*` → `backend:3000` (легаси backend).
- Любые не‑API пути → SPA `index.html`.

Доступность сервисов в Docker:

- Внешний доступ открыт только к фронтенду (Nginx) на `127.0.0.1:8099`.
- `server` и `backend` доступны лишь внутри Docker‑сети (без публикации портов наружу).

## Навигация и UI

Роуты (`frontend/src/router/index.ts`):

- `/login` — ввод логина/пароля (сохраняются локально), переход к настройкам.
- `/settings` — ввод домена EN, ID игры, номера уровня, выбор типа уровня.
- `/upload` — форма загрузки для выбранного типа (динамический компонент).

Ключевые компоненты:

- `components/LoginForm.vue` — запоминает креды через Pinia и переводит на настройки.
- `components/SettingsForm.vue` — валидация домена/игры, первичная авторизация, переход к загрузке.
- `components/UploadForm.vue` — переключатель между типами уровней:
  - `types/Olymp15/index.vue`
  - `types/Olymp31/index.vue`
  - `types/Olymp63/index.vue`
  - `types/Olymp127/index.vue`
  - `types/Type100500/index.vue`
- `components/types/Olymp15/Answers.vue` — таблица ответов/секторов/бонусов и их параметров.
- `components/UploadProgress.vue` — плавающее окно прогресса.
- `components/VersionLabel.vue` — отображение версии (если нужно).

Дополнения для `types/Type100500`:

- В таблице есть колонка `Уровни бонуса`. В каждой строке — кнопка «уровни» для выбора доступности бонуса:
  - Радио‑опции: «На всех уровнях» или «На указанных уровнях»;
  - При выборе «на указанных» доступна сетка чекбоксов уровней (20 столбцов), список можно «Обновить»;
  - Для удобства есть кнопка «Уровни бонусов» в контролах блока — массовое применение выбранной опции и уровней ко всем строкам блока;
  - В ячейке колонки отображается «все уровни», либо до 5 выбранных уровней (остальное сворачивается в `…`).

Вспомогательное:

- `utils/olymp.ts` — генерация раскладки таблицы «олимпийки» для 2^k−1 секторов (15/31/63/127).
- `utils/visibility.ts` — предупреждения и слежение за видимостью вкладки во время массовых загрузок; уведомления о завершении.
- `services/uploader.ts` — ключевой сервис фронтенда, оркестрирует процесс заливки: `sendTask` → `sendSector` → `sendBonuses`, формирует `application/x-www-form-urlencoded` нагрузку, выдерживает паузы между запросами и, при необходимости, повторно инициирует авторизацию.

Стили: Tailwind 4, базовые утилитарные классы + кастомные классы форм.

### Процесс работы пользователя

1. Авторизация: на `/login` пользователь вводит логин и пароль (сохраняются в Pinia; см. раздел «Безопасность»).
2. Настройки: на `/settings` указываются домен EN, ID игры, № уровня и тип уровня; выполняется проверка наличия игры и первичная авторизация через `/api/auth/login`.
3. Заполнение: на `/upload` заполняются ответы, параметры секторов/бонусов, шаблоны закрытых названий; изменения сохраняются в localStorage по типу уровня.
4. Загрузка: запускается по кнопкам «Залить задание/секторы/бонусы» с визуальным прогрессом и контролем видимости вкладки.

## Состояние, localStorage и сессии

Хранилища Pinia:

- `store/auth.ts` — хранит `username`, `password`, `loggedIn`, `error`; метод `authenticate(domain)` делает POST на `/api/auth/login` и сохраняет признак авторизации. Включён `persist: true` → состояние (включая пароль) хранится в `localStorage` браузера.
- `store/index.ts`:
  - `useUploadStore` — домен (`domain`), ID игры (`gameId`), номер уровня (`levelId`), тип (`uploadType`), параметры (`config`) и массив строк «ответов» для текущего типа; selective‑persist (`pick`) — сохраняем `domain`, `gameId`, `levelId`, `uploadType` в `localStorage`. Данные конкретного типа кешируются под ключом `upload-<type>`.
  - Также есть альтернативный `useAuthStore` с вызовом `/api/login` из легаси backend — не используется текущим UI.
- `store/progress.ts` — состояние прогресса массовой загрузки.

Хранение для `Type100500`:

- Данные табов (список строк в каждом блоке) сохраняются в `localStorage` под ключом `type100500-tabs`.
- Для каждой строки могут храниться:
  - `targetLevels: string[]` — дополнительные уровни, выбранные пользователем (кроме базового уровня из настроек);
  - `allLevels: boolean` — если истина, бонус доступен на всех уровнях (без чекбоксов уровней).

Сессии и куки:

- Прокси‑сервер (`server/index.js`) использует `express-session` (in‑memory) для хранения агрегированной строки кук EN в `req.session.authCookie`.
- На логине прокси берёт `Set-Cookie` от `https://{domain}.en.cx/Login.aspx?lang=ru`, собирает их в строку и кладёт в сессию. Далее для всех `/api/admin/*` запросов подставляет `Cookie: {authCookie}`.
- При каждом ответе EN проверяется заголовок `Set-Cookie` и при необходимости обновляется `authCookie` в сессии (продление/смена ASP.NET_SessionId и т.п.).

Важно: сессии `express-session` хранятся в памяти процесса → при рестарте теряются; для продакшена нужен внешний store (Redis/Memcached) и sticky‑sessions на балансировщике.

Безопасность: хранение пароля в `localStorage` — риск. Рекомендуется убрать `password` из persist и хранить его только в памяти вкладки либо использовать другой способ авторизации.

## Типы уровней и данные для заливки

Поддерживаемые типы:

- `olymp` (15), `olymp31` (31), `olymp63` (63), `olymp127` (127) — «олимпийка» 2^k−1.
- `100500` — «произвольный» тип (заготовка для больших конфигураций).

Единица данных ответа/сектора/бонуса (`services/uploader.ts: Answer`):

- `number`: порядковый номер ячейки
- `variants: string[]`: варианты ответа (до 10)
- `inSector: boolean`: пометка, что отправлять в сектора
- `inBonus: boolean`: пометка, что отправлять как бонус
- `bonusTime`: `{ hours, minutes, seconds, negative }`
- `closedText`: текст/URL закрытого сектора (может быть ссылкой на изображение)
- `displayText`: «открытый» текст (подсветка зелёным при предпросмотре)
- `sectorName?`, `bonusName?`, `noHint?`: дополнительные поля (по мере необходимости)
- `targetLevels?`: массив выбранных уровней для бонуса (используется при опции «на указанных уровнях» в типе `100500`)
- `allLevels?`: если `true`, бонус отмечается как доступный «на всех уровнях» (радио‑кнопка), отметка чекбоксов уровней не требуется

Глобальные настройки формы:

- Режим закрытия уровня (`sectorMode`):
  - `all` — все сектора;
  - `initialAndFinal` — стартовые + финальный;
  - `finalOnly` — только финальный;
  - `custom` — ручная отметка чекбоксами.
- Быстрое бонусное время — копируется во все строки.
- Шаблон «закрытого сектора» — подстановка `&` на номер сектора; если значение — URL `http/https`, в предпросмотре и при заливке формируется `<a><img .../></a>`.

Предпросмотр:

- Генерация HTML «олимпийки» через `generateOlympLayout(total, levelId)`. Режимы: закрытый/открытый. В режиме «открытый» текст оборачивается в `<p class="up">`; для ссылок на изображения — `<img>` без этой обёртки.

Троттлинг:

- Между запросами к EN выдерживается пауза `SLEEP_MS = 1200ms`.
- При массовой отправке бонусов каждые 25 записей выполняется повторная авторизация для продления сессии.

## API: маршруты и контракт

Маршруты прокси‑сервера (`server/index.js`):

- POST `/api/auth/login`
  - body: `login`, `password`, `domain`
  - поведение: логин на `https://{domain}.en.cx/Login.aspx?lang=ru`, агрегирует куки в `req.session.authCookie`
  - ответ: `{ ok: true }` при успехе; коды ошибок 400/500

- POST `/api/admin/task`
  - body: `domain`, `gid` (GameID), `level`, `inputTask` (HTML задания)
  - целевой URL EN: `/Administration/Games/TaskEdit.aspx?gid={gid}&level={level}`
  - отправка формы: `inputTask`
  - статус 302 от EN конвертируется в 200 для клиента

- POST `/api/admin/sector`
  - body: `domain`, `gid`, `level`, `txtSectorName?`, `savesector` (пробел), далее пары ответов
  - пары ответов формируются фронтом:

```http
txtAnswer_0=ВАРИАНТ_1
ddlAnswerFor_0=0
txtAnswer_1=ВАРИАНТ_2
ddlAnswerFor_1=0
...
```

  - целевой URL EN: `/Administration/Games/LevelEditor.aspx?gid={gid}&level={level}`
  - статус 302 от EN конвертируется в 200

- GET `/api/admin/bonus-form`
  - query: `domain`, `gid`, `level`
  - возвращает HTML формы BonusEdit, из которого фронтенд извлекает имя чекбокса уровня `level_<...>`

- POST `/api/admin/bonus`
  - body: `domain`, `gid`, `level` (игнорируются при отправке), далее полезная нагрузка:

```http
txtBonusName=Название
txtHelp=<script>document.getElementById("{level}_{NN}").innerHTML="...";</script>
answer_-1=ВАРИАНТ_1
answer_-2=ВАРИАНТ_2
txtHours=H
txtMinutes=M
txtSeconds=S
negative=on               # опционально, если время отрицательное
level_{X}=on              # чекбокс, соответствующий текущему уровню (из бонус-формы)
```

  - целевой URL EN: `/Administration/Games/BonusEdit.aspx?gid={gid}&level={level}&bonus=0&action=save`
  - статус 302 от EN конвертируется в 200

Легаси backend (`backend/src/index.ts`):

- POST `/api/login` → авторизация через `https://world.en.cx/login/signin?json=1`, пробрасывает `Set-Cookie` клиенту; CORS открыт для `http://localhost:5173`.
- POST `/api/upload` → заглушка, планировалась как единая точка отправки; текущий UI не использует.

Примечание по Nginx прокси:

- `/api/auth/*`, `/api/admin/*` идут в `server:3001` и используют сессионные куки EN в памяти сервера.
- Остальное `/api/*` (включая легаси `/api/login`, `/api/upload`) идёт в `backend:3000`.

## Поток авторизации

1) Пользователь вводит логин/пароль на `/login` → `store/auth.setCredentials` сохраняет их локально (persist).

2) На `/settings` после проверки домена и наличия игры вызывается `authStore.authenticate(domain)`:

- фронтенд: POST `/api/auth/login` c `{ login, password, domain }`;
- прокси: логинится на EN, собирает кук‑строку в `req.session.authCookie`;
- фронтенд: выставляет `loggedIn=true` при 200.

3) Все дальнейшие вызовы `/api/admin/*` выполняются с заголовком `Cookie` от имени сессии прокси‑сервера.

## Потоки заливки

Задание (Task):

1) В предпросмотре формируется HTML таблицы «закрытой» версии. 2) POST `/api/admin/task` с `inputTask` (HTML) → прокси постит форму TaskEdit на EN.

Сектора (Sectors):

1) Фильтруются строки, помеченные `inSector` (режим `sectorMode` может массово проставлять пометки).
2) Для каждой строки отправляется POST `/api/admin/sector` с полями `txtAnswer_i/ddlAnswerFor_i` и, при необходимости, `txtSectorName`.
3) Между запросами — `SLEEP_MS` (1200ms).

Бонусы (Bonuses):

1) Сначала GET `/api/admin/bonus-form` → фронтенд парсит HTML и находит:
   - имя чекбокса для текущего уровня `level_<...>`;
   - отображаемый список всех уровней (label → name) для выбора «на указанных».
2) Для каждой строки `inBonus` формируется POST `/api/admin/bonus`:
   - `txtBonusName`, `answer_-N`, `txtHours/txtMinutes/txtSeconds`, `negative=on` при необходимости;
   - `txtHelp` — `<script>…</script>` для замены содержимого соответствующей ячейки таблицы уровня (`{level}_{NN}`);
   - Радио‑параметр `rbAllLevels`: `0` — «на всех уровнях», `1` — «на указанных уровнях»;
   - Если выбрано «на указанных» — отмечаются чекбоксы: базовый уровень из настроек + выбранные уровни для конкретной строки (могут различаться по строкам);
   - Если выбрано «на всех уровнях» — чекбоксы уровней не отправляются.
3) Между запросами — `SLEEP_MS`; каждые 25 бонусов — повторная авторизация.

## Добавление нового типа уровня

- UI:
  1) Создать новый компонент в `frontend/src/components/types/<NewType>/index.vue` (можно переиспользовать `Answers.vue`).
  2) Добавить пункт выбора в селектор типа на странице настроек: `components/SettingsForm.vue` (`<select v-model="store.uploadType">`).
  3) Подключить новый тип в `components/UploadForm.vue` (switch по `uploadType`).
  4) В `useUploadStore` добавить логику инициализации количества ответов и хранения настроек для нового типа.
  5) При необходимости адаптировать генерацию раскладки (для не 2^k−1 — написать свой генератор вместо `generateOlympLayout`).

- Отправка:
  1) Если нужен иной формат параметров форм EN — расширить функции в `services/uploader.ts` или добавить новые под конкретный тип.
  2) При добавлении новых API‑маршрутов на прокси — реализовать их в `server/index.js` и прокинуть через `nginx.conf` (в большинстве случаев достаточно существующих `/api/admin/*`).

## Рекомендации по продакшену

- Перенести `express-session` на внешний стор (Redis) и настроить sticky‑sessions.
- Убрать хранение пароля из persist (`store/auth.ts`) или шифровать/не хранить вовсе.
- Добавить централизованный логгинг запросов/ответов и метрик задержек.
- Учесть rate‑limits EN: параметризовать `SLEEP_MS` и добавить backoff при ошибках 429/5xx.

## Сборка и запуск

Через Docker Compose:

```bash
docker-compose up --build
```

После старта фронтенд доступен на `http://127.0.0.1:8099`.

Локальная разработка (вариант):

- frontend: `cd frontend && npm ci && npm run dev`
- server: `cd server && npm ci && npm start` (порт 3001)
- backend (не обязателен): `cd backend && npm ci && npm run dev` (порт 3000)

Убедитесь, что фронтенд при разработке проксирует `/api/*` на соответствующие локальные порты (в Docker это делает Nginx; локально настройте Vite proxy для `/api/auth/*` и `/api/admin/*` на `http://localhost:3001`, а при необходимости — `/api/*` на `http://localhost:3000`).

## Краткий глоссарий

- «Задание» (Task) — HTML‑блок уровня, чаще всего таблица «олимпийки» в закрытом виде.
- «Сектор» (Sector) — ответ(ы) уровня, заливается в LevelEditor с параметрами `txtAnswer_i/ddlAnswerFor_i`.
- «Бонус» (Bonus) — дополнительный ответ с временем; создаётся через BonusEdit, требует выбора уровня (чекбокс `level_<...>`).


