# Новая архитектура типов уровней

Этот файл с концептуальным представлением новой архитектуры типов уровней. Новая архитектура должна представлять собой конструктор, в котором существует единая база полей, их сниппеты (код), единая база контрол-элементов, единая база кнопок, реестр взаимосвязей между этими элементами (если есть такое-то поле, то вместе с ним на страницу подключается такой-то контрол-элемент и такая-то кнопка), а также конфиги для каждого типа уровня, в которых просто перечислен нужный набор элементов из этих баз.

Новая архитектура типов уровней должна работать быть создана "с нуля" и работать отдельно от старой архитектуры, она должна быть четко отделена, нельзя допустить чтобы она взаимодействовала со старой архитектурой. После реализации новой архитектуры, старая архитектура будет упразднена. Старая архитектура будет нужна при разработке новой для того, чтобы брать из нее то, что уже работает и переделывать под новый формат.

В данный момент типы уровней функционируют, многое из того что написано в этом документе работает, просто возможно не так как описано. При анализе проекта нужно сравнивать как написано в документе (новая архитектура) и как работает сейчас (старая архитектура).

Некоторые или многие части проекта могут быть оставлены как есть (или лишь немного видоизменены), потому что они уже настроены и работают (например, Encounter API, отправка пейлоадов, сессии, авторизация, задержки и пр.)

***Важно! Весь UI должен быть построен на компонентах PrimeVue, без использования кастомного html или css кода.***

Характеристики новой архитектуры:
- Чистое разделение логики и представления
- 100% PrimeVue компоненты
- Унифицированные стили и взаимодействия
- Консистентный UX между всеми типами
- Понятная структура
- Чистый, современный и минималистичный код
- Добавление новых типов уровней через создание конфига
- Легкое тестирование и поддержка
- DRY принцип
- Комментирование сложных или больших участков кода

## Типы уровней

Настройка страницы загрузки, главной целью которого является "заливка" контента в Encounter в определенном виде.

Сейчас существует 2 типа уровней:
1. Олимпийка
2. 100500

### Подтипы уровней

У каждого типа уровня может быть подтип. Это видоизмененный тип уровня с некоторыми переменными, в основном количественными или размерными.

Предполагается, что пока будут 1 переменная `Размерность`, которая влияет на:
- количество ответов в **LevelContent**
- использование в теле пейлоада для "Загрузки задания"

## Общий шаблон страницы загрузки

Представлен в виде единого файла страницы, которая доступна по адресу /uploads.

Содержит в себе каркас страницы с перечнем функциональных блоков (слотов):
1. **LevelHeader** - "шапка", в котрой название типа уровня, данные из настроек (автор, домен, игра, уровень).
2. **LevelControlPanel** - панель управления (контрол-панель) с формами и элементами для массового управления таблицей контента.
3. **LevelContent** - таблица с данными (контент) для загрузки (заливки), представлена в виде DataTable.
4. **LevelFooter** - "подвал" с кнопками. Разделено на 3 части: левая, центральная, правая.

Логическое содержание общего шаблона страницы загрузки:
<LevelUploadLayout>
<LevelHeader />
<LevelControlPanel />
<LevelContent />
<LevelFooter />
</LevelUploadLayout>

Каждый слот имеет свою представление и разметку (обертку).

## Единые базы

### **База полей**

Поле (`levelField`) - это элемент типа уровня, который может быть использован на странице загрузки. Поля - это основа страницы загрузки. Набор всех известных полей в системе образует единую **Базу полей**.

У каждого поля есть такие свойства:
- уникальное название (как идентификатор)
- колонка в таблице для слота **LevelContent**
- контрол-сниппет в форме для слота **LevelControlPanel** из базы **Контрол-сниппетов**

Колонки для слота **LevelContent**

Содержание таблицы контента - это **Ответы** (как сущность), каждый ответ - это отдельная строка в таблице. У ответов может быть несколько **Вариантов** (добавляются плюсом, удаляются минусом). Первая колонка **#** с порядковым номером **ответа** является просто технической, присутствует всегда по-умолчанию.

Порядок колонок в таблице должен соответствовать порядку в базе полей. При смене порядка колонок в базе полей - порядок в таблице также изменится.

*Физическое содержание колонки - это кусок кода, в котором PrimeVue-компонент в возможной обертке содержит переменную, значение которой отображается на странице. В качестве эталонного куска кода будут приведены примеры строк из файлов. Из них нужно взять сам html-код и местоположение переменных (так как сами переменные могут быть заменены в новой архитектуре).*

#### Ответ

Колонка в таблице для слота **LevelContent**:
- Название колонки: `Ответ`
- Логическое содержимое ячейки: 1 или несколько вариантов ответов
- Физическое содержание колонки: frontend\src\components\types\olymp\Answers.vue (5-37)

Контрол-сниппет в форме для слота **LevelControlPanel** из базы **Контрол-сниппетов**: нет

#### Сектор

Колонка в таблице для слота **LevelContent**:
- Название колонки: `Сектор`
- Логическое содержимое ячейки: чекбокс нужно ли учитывать этот сектор при заливке
- Физическое содержание колонки: frontend\src\components\types\olymp\Answers.vue (38-46)

Контрол-сниппет в форме для слота **LevelControlPanel** из базы **Контрол-сниппетов**: `Закрытие уровня`

#### Бонус

Колонка в таблице для слота **LevelContent**:
- Название колонки: `Бонус`
- Логическое содержимое ячейки: чекбокс нужно ли учитывать этот бонус при заливке
- Физическое содержание колонки: frontend\src\components\types\olymp\Answers.vue (47-51)

Контрол-сниппет в форме для слота **LevelControlPanel** из базы **Контрол-сниппетов**: нет

#### Уровни бонуса

Колонка в таблице для слота **LevelContent**:
- Название колонки: `Уровни бонуса`
- Логическое содержимое ячейки: выбор уровней, в которые будет залит бонус
- Физическое содержание колонки: эталонного кода нет, так как эта колонка используется только в типе уровня "100500", который не переведен на PrimeVue. Однако, текущая реализация (плохая) находится тут: frontend\src\components\types\Type100500\index.vue (144-148 и 151-159, в данный момент разнесено по двум колонкам, но надо сделать в одной)

Контрол-сниппет в форме для слота **LevelControlPanel** из базы **Контрол-сниппетов**: `Уровни бонусов`

#### Бонусное время

Колонка в таблице для слота **LevelContent**:
- Название колонки: `Бонусное время`
- Логическое содержимое ячейки: 3 числовых поля с количеством бонусного времени (часы, минуты, секунды) + чекбокс "отрицательное"
- Физическое содержание колонки: frontend\src\components\types\olymp\Answers.vue (52-86)

Контрол-сниппет в форме для слота **LevelControlPanel** из базы **Контрол-сниппетов**: `Бонусное время (ч, м, с)`

#### Задержка

Колонка в таблице для слота **LevelContent**:
- Название колонки: `Задержка`
- Логическое содержимое ячейки: 3 числовых поля с количеством времени для задержки (часы, минуты, секунды)
- Физическое содержание колонки: эталонного кода нет, так как эта колонка используется только в типе уровня "100500", который не переведен на PrimeVue. Однако, текущая реализация (плохая) находится тут: frontend\src\components\types\Type100500\index.vue (171-177), сделать внешне как `Бонусное время`

Контрол-сниппет в форме для слота **LevelControlPanel** из базы **Контрол-сниппетов**: `Задержка (ч, м, с)`

#### Ограничение

Колонка в таблице для слота **LevelContent**:
- Название колонки: `Ограничение`
- Логическое содержимое ячейки: 3 числовых поля с количеством времени для ограничения (часы, минуты, секунды)
- Физическое содержание колонки: эталонного кода нет, так как эта колонка используется только в типе уровня "100500", который не переведен на PrimeVue. Однако, текущая реализация (плохая) находится тут: frontend\src\components\types\Type100500\index.vue (178-174), сделать внешне как `Бонусное время`

Контрол-сниппет в форме для слота **LevelControlPanel** из базы **Контрол-сниппетов**: `Ограничение (ч, м, с)`

#### Закрытый сектор

Колонка в таблице для слота **LevelContent**:
- Название колонки: `Закрытый сектор`
- Логическое содержимое ячейки: текстовое поле закрытого сектора
- Физическое содержание колонки: frontend\src\components\types\olymp\Answers.vue (87-95)

Контрол-сниппет в форме для слота **LevelControlPanel** из базы **Контрол-сниппетов**: `Название закрытого сектора`

#### Открытый сектор

Колонка в таблице для слота **LevelContent**:
- Название колонки: `Открытый сектор`
- Логическое содержимое ячейки: текстовое поле открытого сектора
- Физическое содержание колонки: frontend\src\components\types\olymp\Answers.vue (96-104)

Контрол-сниппет в форме для слота **LevelControlPanel** из базы **Контрол-сниппетов**: `Заполнить открытые сектора`

#### Название сектора

Колонка в таблице для слота **LevelContent**:
- Название колонки: `Название сектора`
- Логическое содержимое ячейки: текстовое поле с названием сектора
- Физическое содержание колонки: эталонного кода нет, так как эта колонка используется только в типе уровня "100500", который не переведен на PrimeVue. Однако, текущая реализация (плохая) находится тут: frontend\src\components\types\Type100500\index.vue (185-187)

Контрол-сниппет в форме для слота **LevelControlPanel** из базы **Контрол-сниппетов**: `Название секторов`

#### Название бонуса

Колонка в таблице для слота **LevelContent**:
- Название колонки: `Название бонуса`
- Логическое содержимое ячейки: текстовое поле с названием сектора
- Физическое содержание колонки: эталонного кода нет, так как эта колонка используется только в типе уровня "100500", который не переведен на PrimeVue. Однако, текущая реализация (плохая) находится тут: frontend\src\components\types\Type100500\index.vue (188-190)

Контрол-сниппет в форме для слота **LevelControlPanel** из базы **Контрол-сниппетов**: `Название бонусов`

#### Бонусное задание

Колонка в таблице для слота **LevelContent**:
- Название колонки: `Бонусное задание`
- Логическое содержимое ячейки: текстовое многострочное поле с бонусным заданием, может принимать html/css/js код
- Физическое содержание колонки: эталонного кода нет, так как эта колонка используется только в типе уровня "100500", который не переведен на PrimeVue. Однако, текущая реализация (плохая) находится тут: frontend\src\components\types\Type100500\index.vue (191-193), текстареа сделать расширяемой при фокусе

Контрол-сниппет в форме для слота **LevelControlPanel** из базы **Контрол-сниппетов**: `Бонусные задания`

#### Подсказка

Колонка в таблице для слота **LevelContent**:
- Название колонки: `Подсказка`
- Логическое содержимое ячейки: текстовое многострочное поле с бонусным заданием, может принимать html/css/js код
- Физическое содержание колонки: эталонного кода нет, так как эта колонка используется только в типе уровня "100500", который не переведен на PrimeVue. Однако, текущая реализация (плохая) находится тут: frontend\src\components\types\Type100500\index.vue (194-196), текстареа сделать расширяемой при фокусе

Контрол-сниппет в форме для слота **LevelControlPanel** из базы **Контрол-сниппетов**: `Подсказки (по факту выполнения)`

### **База контрол-сниппетов** (для слота **LevelControlPanel**)

Контрол-сниппет: это компонент для массового управления конкретным полем в таблице контента.

У каждого контрол-сниппета есть привязка к полю (которым он управляет), но не у каждого поля может быть контрол-сниппет. Контрол-сниппет может быть привязан только к одному полю.

Порядок контрол-сниппетов в контрол-панели должен соответствовать порядку в базе контрол-сниппетов. При смене порядка контрол-сниппетов в базе контрол-сниппетов - порядок в контрол-панели также изменится.

Эталонные коды сниппетов (по аналогии с базой полей) указаны.

#### Закрытие уровня

- управляет полем: `Ответ`
- Код сниппета: frontend\src\components\types\OlympBase.vue (8-22)

#### Бонусное время (ч, м, с)

- управляет полем: `Бонусное время`
- Код сниппета: frontend\src\components\types\OlympBase.vue (23-75)

#### Название закрытого сектора

- управляет полем: `Закрытый сектор`
- Код сниппета: frontend\src\components\types\OlympBase.vue (76-86)

#### Заполнить открытые сектора

- управляет полем: `Открытый сектор`
- Код сниппета: frontend\src\components\types\OlympBase.vue (87-92)

#### Название секторов

- управляет полем: `Название сектора`
- Код сниппета: эталонного кода нет, так как этот контрол-элемент используется только в типе уровня "100500", который не переведен на PrimeVue. Однако, текущая реализация (плохая) находится тут: frontend\src\components\types\Type100500\index.vue (31-34)

#### Название бонусов

- управляет полем: `Название бонуса`
- Код сниппета: эталонного кода нет, так как этот контрол-элемент используется только в типе уровня "100500", который не переведен на PrimeVue. Однако, текущая реализация (плохая) находится тут: frontend\src\components\types\Type100500\index.vue (35-38)

#### Задержка (ч, м, с)

- управляет полем: `Задержка`
- Код сниппета: эталонного кода нет, так как этот контрол-элемент используется только в типе уровня "100500", который не переведен на PrimeVue. Однако, текущая реализация (плохая) находится тут: frontend\src\components\types\Type100500\index.vue (51-58)

#### Ограничение (ч, м, с)

- управляет полем: `Ограничение`
- Код сниппета: эталонного кода нет, так как этот контрол-элемент используется только в типе уровня "100500", который не переведен на PrimeVue. Однако, текущая реализация (плохая) находится тут: frontend\src\components\types\Type100500\index.vue (59-66)

#### Бонусные задания

- управляет полем: `Бонусное задание`
- Код сниппета: эталонного кода нет, так как этот контрол-элемент используется только в типе уровня "100500", который не переведен на PrimeVue. Однако, текущая реализация (плохая) находится тут: frontend\src\components\types\Type100500\index.vue (69-72), текстареа сделать расширяемой при фокусе

#### Подсказки (по факту выполнения)

- управляет полем: `Подсказка`
- Код сниппета: эталонного кода нет, так как этот контрол-элемент используется только в типе уровня "100500", который не переведен на PrimeVue. Однако, текущая реализация (плохая) находится тут: frontend\src\components\types\Type100500\index.vue (73-76), текстареа сделать расширяемой при фокусе

#### Уровни бонусов

- управляет полем: `Уровни бонуса`
- Код сниппета: эталонного кода нет, так как этот контрол-элемент используется только в типе уровня "100500", который не переведен на PrimeVue. Однако, текущая реализация (плохая) находится тут: frontend\src\components\types\Type100500\index.vue (77)

### **База кнопок** (для слота **LevelFooter**)

Так как **LevelFooter** разделен на 3 части, то в каждой из них могут быть только определенные наборы кнопок.

1. Набор **Навигационные кнопки** (слева):
- `Назад`

Не имеют настроек и переменных. Пока планируется только 1 кнопка "Назад".

2. Набор **Функциональные кнопки** (по центру):
- `Добавить коды` (ручное добавление кодов в таблицу **LevelContent**. В данный момент эта кнопка находится в контрол-панели старой архитектуры типа уровня "100500" (frontend\src\components\types\Type100500\index.vue, строка 78), ее нужно перенести в **LevelFooter** так как она не имеет связи с **Полями**)
- `Очистить` (очистка от данных в таблице **LevelContent**)
- `Экспорт` (выгрузка данных из таблицы **LevelContent**)
- `Импорт` (загрузка контента в таблицу **LevelContent**)
- `Предпросмотр` (визуализация содержания **Пейлоада** для "Отправки задания")

Не имеют настроек и переменных.

3. Набор **Экшн-кнопки** (справа):
- `Залить задание`
- `Залить секторы` (с галкой `Объединить сектора (БМП)` или без галки)
- `Залить бонусы`

Работают с сущностью **Пейлоадами**. При использовании "заливают" (отправляют по урлу в Encounter) данные из таблицы контента **LevelContent** в формате, определенном в конфиге типа уровня (настройка **Пейлоадов**).

## Пейлоады

Набор пейлоадов для заливки в Encounter. В зависимости от конфига типа уровня будут иметь разное содержание. Каждый пейлоад имеет прямую и постоянную связь с кнопкой заливки. Проще говоря, у каждой кнопки свой пейлоад. У кнопки может быть только 1 пейлоад, у пейлоада может быть только 1 кнопка.

1. `TaskPayload` - для кнопки `Залить задание`
2. `SectorPayload` - для кнопки `Залить секторы` (связан с опцией `Объединить сектора (БМП)` для этой кнопки)
3. `BonusPayload` - для кнопки `Залить бонусы`

До конца нет понимания как должны унифицироваться пейлоады, но хочется избежать дублирования кода при формировании содержания пейлоада для отправки в Encounter. Возможно это уже реализовано в старой архитектуре.

## Конфиги типов уровней

Каждый уровень имеет свой конфиг в виде одного файла, в котором перечислены:
- наличие подтипов (например, у "Олимпийки" есть подтипы, а у "100500" нет. У каждого подтипа есть свое название `Название подтипа`)
- ручное добавление кодов: `true` (присутствует кнопа `Добавить код`, а также имеется возможность удалить строку с ответом и всеми его вариантами в таблице), `false` (принимаетколичество строк в таблице контента определено переменной `Размерность`)
- переменные подтипов (если есть подтипы. Для примера, размерность олимпийки: 15, 31, 63, 127), пока только одна - `Размерность` (эта переменная обязательна к заполнению, если для "ручного добавления кодов" установлено значение `false`)
- название типа уровня (для заголовка) для **LevelHeader**: `string` (состоит из самого названия и дополняется на странице названием `Название подтипа` если имеется подтип и он выбран)
- блоки (табы), включены или выключены: `true`, `false` (если `true` - то на странице может быть от 1 блока и больше. Если `false` - то на странице может быть только один блок. Подробнее в этом документе в разделе **Блоки (табы)**)
- набор элементов из базы полей (с опциями этих полей, если таковые есть)
- кнопки из базы кнопок (с опциями этих кнопок, если таковые есть)
- пейлоады для загрузки

### Конфиг **Олимпийка**

- подтипы: **15 секторов**, **31 сектор**, **63 сектора**, **127 секторов**
- ручное добавление кодов: `false`
- переменные подтипов: **Размерность** (со значениями: `15`, `31`, `63`, `127`)
- название: `Олимпийка`
- блоки: `false`
- поля: `Ответ`, `Сектор`, `Бонус`, `Бонусное время`, `Закрытый сектор`, `Открытый сектор`
- кнопки: 
1. **Навигационные кнопки**: `Назад`
2. **Функциональные кнопки**: `Очистить`, `Экспорт`, `Импорт`, `Предпросмотр`
3. **Экшн-кнопки**: `Залить задание`, `Залить секторы` (с отключенной опцией `Объединить сектора (БМП)`, то есть без галки), `Залить бонусы`
- пейлоады:
1. `TaskPayload`: пример реализации из старой архитектуры - frontend\src\services\uploader.ts (176-227)
2. `SectorPayload`: пример реализации из старой архитектуры - frontend\src\services\uploader.ts (229-290)
3. `BonusPayload`: пример реализации из старой архитектуры - frontend\src\services\uploader.ts (292-436)

### Конфиг **100500**

- подтипы: нет
- ручное добавление кодов: `true`
- переменные подтипов: нет
- название: `100500 секторов и бонусов`
- блоки: `true`
- поля: `Ответ`, `Сектор`, `Бонус`, `Уровни бонуса`, `Бонусное время`, `Задержка`, `Ограничение`, `Название сектора`, `Название бонуса`, `Бонусное задание`, `Подсказка`
- кнопки: 
1. **Навигационные кнопки**: `Назад`
2. **Функциональные кнопки**: `Добавить коды`, `Очистить`, `Экспорт`, `Импорт`
3. **Экшн-кнопки**: `Залить секторы` (с включенной опцией `Объединить сектора (БМП)`, то есть с галкой), `Залить бонусы`
- пейлоады:
1. `TaskPayload`: пример реализации из старой архитектуры - frontend\src\services\uploader.ts (176-227), я могу ошибаться, но вроде бы тот же код, что и для отправки кодов для "Олимпийка"
2. `SectorPayload`: пример реализации из старой архитектуры - frontend\src\services\uploader.ts (229-290), я могу ошибаться, но вроде бы тот же код, что и для отправки кодов для "Олимпийка"
3. `BonusPayload`: пример реализации из старой архитектуры - frontend\src\services\uploader.ts (292-436), я могу ошибаться, но вроде бы тот же код, что и для отправки кодов для "Олимпийка"

## Блоки (табы)

Так как в типе уровня "100500" имеются "Блоки" (в виде табов в контрол-панели, а в Олимпийке нет, то следует унифицировать эти блоки для каждого типа уровня (в том числе для будущих). "Блоки" (табы) - это настройка типа уровня, они не входят в перечень какой-либо базы. Имеется только флаг `isMultiBlocks` со значениями:
- `true`: в таком случае есть возможность добавлять новые табы, они физически и визуально присутствуют на странице. Пример: присутствует в типе уровня "100500".
- `false`: в таком случае считать что блок (таб) только один. Пример: отсутствует визуализация табов в типе уровня "Олимпийка".

Надо придумать где будут логически располагаться эти блоки. в UI они должны остаться выше контрол-панели. Табы должны быть реализованы через PrimeVue-компонент `Tabs`.

## Экспорт/импорт

Так как Блоки будут присутствовать теперь во всех типах уровней, то следует унифицировать и файлы для экспорта/импорта. В данный момент в типе уровня "100500" конструкция для Блоков (табов) присутствует, даже если блок всего 1. А в типе уровня "Олимпийка"

## Задача

Нужно составить общий план реализации этой архитектуры в виде файла /docs/level-plan.md, разбитый на такие шаги, которые можно сделать за один "подход". Для каждого такого шага мы будем предварительно составлять отдельный собственный план.

Например, я вижу такой план (ты можешь и должен его откорректировать в правильную сторону и последовательность):
1. Выделение отдельной области в файловой системе для новой архитектуры, планирование и создание структуры (папок и файлов)
2. Подготовка и продумывания как разрабатывать новую архитектуру без удаления и изменения старой архитектуры (чтобы можно было в нее смотреть и забирать по кусочкам все необходимое).
3. Техническая подготовка окружения для использования и тестирования новой архитектуры (роутинг и все что окружает типы уровней, но не относится к ним напрямую).
4. Создание базы полей
5. Создание базы контрол-сниппетов
6. Создание базы кнопок
7. Пейлоады
8. Создание реестра типов уровней для их регистрации, создание структуры конфигов
9. Регистрация типа уровня "Олимпийка" с созданием конфига и настройкой подтипов + тестирование (функциональное и UI)
10. Регистрация типа уровня "100500" с созданием конфига + тестирование (функциональное и UI)
11. Анализ проделанной работы, поиск дублирования и возможности оптимизации/улучшения

Каждый шаг может быть разбит не на подшаги, но на перечень того, что нужно сделать в рамках этого шага. Если выполнение шага в рамках одной итерации разработки слишком объемное, то этот шаг следует разбить на несколько шагов (со своим перечнем что нужно сделать).

Мы начинаем с "Шаг 1", сперва продумываем для него план, ты задаешь вопросы и уточнения, я отвечаю и уточняю, согласовываем итоговый план для этого шага и после этого приступаем к выполнению. После выполнения проверяем все ли хорошо и если да - двигаемся к следующему шагу. То есть если в файле плана будет 5 шагов, это значит что мы будем разрабатывать 5 планов для каждого шага.

Твой общий план в файле /docs/level-plan.md должен содержать чекбоксы напротив каждого шага, которые будут отмечаться выполненными. А также под каждым выполненным шагом нужно будет коротко описывать технические детали реализации этого шага (например, какой файл за что отвечает, какая структура и логика конкретно этого шага).

*Если перед составлением общего плана с шагами у тебя есть вопросы - задавай.*